# 图像保存优化说明

## 功能概述

本次优化主要针对图像保存逻辑，实现了更规范的文件管理机制，包括结果图像保存和源文件备份。

## 主要改进

### 1. 结果图像保存优化

**保存位置**：所有检测结果图像现在保存到 `data/results` 目录下

**命名规则**：
- 基于源文件命名：`原文件名_result.jpg`
- 摄像头检测：`camera_result_时间戳.jpg`

**实现方法**：
```python
def generate_result_filename(self):
    """根据源文件生成结果文件名"""
    if not self.current_source:
        # 如果没有源文件（如摄像头），使用时间戳
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        return f"camera_result_{timestamp}.jpg"
    
    # 获取源文件名（不含路径）
    source_filename = os.path.basename(self.current_source)
    name, ext = os.path.splitext(source_filename)
    
    # 生成结果文件名：原文件名_result.jpg
    result_filename = f"{name}_result.jpg"
    return result_filename
```

### 2. 源文件备份机制

**备份位置**：源文件自动复制到 `data/sources` 目录下

**备份时机**：在保存检测结果到数据库时自动执行

**实现方法**：
```python
def copy_source_to_data_directory(self):
    """将源文件复制到data/sources目录"""
    if not self.current_source or not os.path.exists(self.current_source):
        return None
    
    try:
        # 获取源文件名
        source_filename = os.path.basename(self.current_source)
        
        # 目标路径
        target_path = os.path.join("data", "sources", source_filename)
        
        # 确保目录存在
        os.makedirs(os.path.dirname(target_path), exist_ok=True)
        
        # 复制文件
        import shutil
        shutil.copy2(self.current_source, target_path)
        
        return target_path
    except Exception as e:
        print(f"复制源文件失败: {str(e)}")
        return None
```

### 3. 检测结果处理优化

在 `process_detection_results` 方法中的改进：

```python
# 显示结果图像并保存到指定目录
if hasattr(results[0], 'save'):
    # 生成结果图像文件名
    result_filename = self.generate_result_filename()
    result_path = os.path.join("data", "results", result_filename)
    
    # 确保目录存在
    os.makedirs(os.path.dirname(result_path), exist_ok=True)
    
    # 保存结果图像
    results[0].save(result_path)
    self.result_widget.set_image(result_path)
    
    # 保存结果路径供后续使用
    self.current_result_path = result_path
```

### 4. 数据库保存优化

在 `save_to_database` 方法中的改进：

```python
# 复制源文件到data/sources目录
source_path = self.copy_source_to_data_directory()

# 保存检测记录到数据库
result_path = self.current_result_path if self.current_result_path else ""

success = self.db_operations.save_detection_record(
    patient_info, 
    self.detection_results, 
    source_path if source_path else self.current_source, 
    result_path,
    detection_type
)
```

## 目录结构

优化后的文件结构：

```
project/polpy_detect/
├── data/
│   ├── sources/          # 源文件备份目录
│   │   ├── image1.jpg
│   │   ├── video1.mp4
│   │   └── ...
│   └── results/          # 检测结果目录
│       ├── image1_result.jpg
│       ├── video1_result.jpg
│       ├── camera_result_20241201_143022.jpg
│       └── ...
├── main_ui.py
└── ...
```

## 使用说明

### 1. 图片检测
- 选择图片文件进行检测
- 结果图像保存为：`data/results/原文件名_result.jpg`
- 源文件备份到：`data/sources/原文件名.jpg`

### 2. 视频检测
- 选择视频文件进行检测
- 结果图像保存为：`data/results/原文件名_result.jpg`
- 源文件备份到：`data/sources/原文件名.mp4`

### 3. 摄像头检测
- 启动摄像头进行检测
- 结果图像保存为：`data/results/camera_result_时间戳.jpg`
- 无源文件备份（摄像头实时检测）

## 优势特点

1. **文件管理规范**：统一保存到指定目录，便于管理
2. **命名规则清晰**：基于源文件命名，便于识别
3. **自动备份**：源文件自动备份，防止丢失
4. **目录自动创建**：确保目录存在，避免保存失败
5. **错误处理**：完善的异常处理机制
6. **兼容性好**：支持图片、视频、摄像头多种检测模式

## 注意事项

1. 确保 `data` 目录及其子目录有写入权限
2. 源文件复制失败不会影响检测结果保存
3. 摄像头检测时使用时间戳命名，避免文件名冲突
4. 所有文件操作都有异常处理，确保程序稳定性

## 技术实现

- **文件操作**：使用 `os.path` 和 `shutil` 模块
- **目录创建**：使用 `os.makedirs` 确保目录存在
- **时间戳生成**：使用 `datetime.now().strftime` 生成唯一标识
- **路径处理**：使用 `os.path.basename` 和 `os.path.splitext` 处理文件名 