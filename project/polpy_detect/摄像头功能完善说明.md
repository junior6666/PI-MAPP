# 摄像头功能完善说明

## 功能概述

本次完善主要针对摄像头加载功能，增加了设备检测和用户友好的错误提示。

## 主要改进

### 1. 摄像头可用性检测

在 `toggle_camera()` 方法中增加了以下检测步骤：

1. **设备连接检测**：使用 `cv2.VideoCapture(0).isOpened()` 检查摄像头设备是否连接
2. **图像读取测试**：尝试读取一帧图像，验证摄像头是否真正可用
3. **异常处理**：捕获并处理可能出现的异常情况

### 2. 用户友好的错误提示

根据不同情况提供相应的错误提示：

- **设备未连接**：`"未检测到可用的摄像头设备，请检查摄像头连接后重试。"`
- **设备被占用**：`"摄像头无法读取图像，请检查摄像头是否被其他程序占用或设备是否正常工作。"`
- **启动成功**：`"摄像头已成功启动！"`
- **关闭成功**：`"摄像头已关闭。"`

### 3. 检测功能优化

在 `start_detection()` 方法中增加了对摄像头模式的支持：

- 检查是否有可用的检测源（文件或摄像头）
- 当摄像头激活时，使用摄像头作为检测源
- 支持摄像头实时检测

## 代码实现

### toggle_camera() 方法

```python
def toggle_camera(self):
    """切换摄像头"""
    if not hasattr(self, 'camera_active') or not self.camera_active:
        try:
            # 检查摄像头是否可用
            cap = cv2.VideoCapture(0)
            if not cap.isOpened():
                QMessageBox.warning(self, "摄像头错误", "未检测到可用的摄像头设备，请检查摄像头连接后重试。")
                return
            
            # 尝试读取一帧以验证摄像头是否真正可用
            ret, frame = cap.read()
            if not ret:
                QMessageBox.warning(self, "摄像头错误", "摄像头无法读取图像，请检查摄像头是否被其他程序占用或设备是否正常工作。")
                cap.release()
                return
            
            # 释放摄像头资源
            cap.release()
            
            # 启动摄像头
            self.camera_active = True
            self.camera_btn.setText("📹 关闭摄像头")
            QMessageBox.information(self, "摄像头状态", "摄像头已成功启动！")
            
        except Exception as e:
            QMessageBox.critical(self, "摄像头错误", f"摄像头检测过程中出现错误: {str(e)}")
            return
    else:
        # 关闭摄像头
        self.camera_active = False
        self.camera_btn.setText("📹 加载摄像头")
        QMessageBox.information(self, "摄像头状态", "摄像头已关闭。")
```

### start_detection() 方法优化

```python
def start_detection(self):
    """开始检测"""
    # 检查是否有可用的检测源
    if not self.current_source and not (hasattr(self, 'camera_active') and self.camera_active):
        QMessageBox.warning(self, "警告", "请先选择源文件或启动摄像头")
        return
    
    # ... 其他代码 ...
    
    # 确定检测源
    detection_source = self.current_source
    if hasattr(self, 'camera_active') and self.camera_active:
        # 如果是摄像头模式，使用摄像头作为检测源
        detection_source = 0  # OpenCV摄像头索引
    
    # 执行检测
    results = self.model(detection_source)
```

## 测试功能

创建了 `test_camera.py` 测试脚本，可以独立测试摄像头功能：

```python
python test_camera.py
```

## 使用说明

1. **启动摄像头**：点击"📷 加载摄像头"按钮
2. **检测摄像头**：系统会自动检测摄像头设备是否可用
3. **错误处理**：如果摄像头不可用，会显示相应的错误提示
4. **开始检测**：摄像头启动成功后，可以点击"开始检测"进行实时检测

## 注意事项

1. 确保摄像头设备正确连接到计算机
2. 确保摄像头没有被其他程序占用
3. 在Windows系统上，可能需要管理员权限才能访问某些摄像头设备
4. 如果摄像头检测失败，请检查设备管理器中摄像头是否正常工作 